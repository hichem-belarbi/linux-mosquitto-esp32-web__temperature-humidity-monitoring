<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Température & Humidité — Widget</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#071027;--card:#0f172a;--accent:#06b6d4;--accent2:#7c3aed;--text:#e6eef6}
    *{box-sizing:border-box;font-family:Inter,system-ui,Arial}
    html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg),#041025);color:var(--text)}
    .container{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:24px}
    .wrap{display:flex;gap:28px;align-items:center;max-width:1100px;width:100%}

    .widget{flex:1;min-width:280px;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));border-radius:18px;padding:28px;border:1px solid rgba(255,255,255,0.04);box-shadow:0 12px 40px rgba(2,6,23,0.6);display:flex;flex-direction:column;align-items:center;justify-content:center}
    .label{font-weight:600;color:rgba(255,255,255,0.7);letter-spacing:0.02em}
    .value{font-size:88px;font-weight:800;margin:14px 0;line-height:0.85}
    .unit{font-size:22px;font-weight:700;color:rgba(255,255,255,0.6)}
    .updated{margin-top:10px;font-size:13px;color:rgba(255,255,255,0.5)}

    .temp{background:linear-gradient(135deg,rgba(124,58,237,0.08),rgba(6,182,212,0.04));}
    .hum{background:linear-gradient(135deg,rgba(6,182,212,0.04),rgba(124,58,237,0.04));}

    .statusBar{position:fixed;left:20px;top:20px;padding:8px 14px;border-radius:999px;background:rgba(255,255,255,0.03);font-weight:600;color:rgba(255,255,255,0.9);display:flex;gap:10px;align-items:center;border:1px solid rgba(255,255,255,0.04)}
    .dot{width:12px;height:12px;border-radius:999px;background:#7c3aed;box-shadow:0 6px 18px rgba(124,58,237,0.14)}

    @media(max-width:820px){.wrap{flex-direction:column}.value{font-size:64px}}
  </style>
</head>
<body>
  <div class="statusBar"><div id="dot" class="dot"></div><div id="statTxt">Connexion...</div></div>
  <div class="container">
    <div class="wrap">
      <div class="widget temp" aria-live="polite">
        <div class="label">Température</div>
        <div class="value" id="temp">--</div>
        <div class="unit">°C</div>
        <div class="updated" id="t-up">Dernière mise à jour: —</div>
      </div>

      <div class="widget hum" aria-live="polite">
        <div class="label">Humidité</div>
        <div class="value" id="hum">--</div>
        <div class="unit">%</div>
        <div class="updated" id="h-up">Dernière mise à jour: —</div>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <script>
    const TOPIC_TEMP = 'esp32/dht11/temperature';
    const TOPIC_HUM  = 'esp32/dht11/humidity';

    const tempEl = document.getElementById('temp');
    const humEl  = document.getElementById('hum');
    const tUp = document.getElementById('t-up');
    const hUp = document.getElementById('h-up');
    const statTxt = document.getElementById('statTxt');
    const dot = document.getElementById('dot');

    function now(){ return new Date().toLocaleTimeString(); }

    // change ws://localhost:8080 si besoin
    const client = mqtt.connect('ws://192.168.18.183:8080', { reconnectPeriod:2000, keepalive:30 });

    client.on('connect', () => {
      statTxt.textContent = 'Connecté'; dot.style.background = '#10b981';
      client.subscribe([TOPIC_TEMP, TOPIC_HUM]);
    });

    client.on('reconnect', () => { statTxt.textContent = 'Reconnexion...'; dot.style.background = '#f59e0b'; });
    client.on('close', () => { statTxt.textContent = 'Déconnecté'; dot.style.background = '#ef4444'; });
    client.on('error', () => { statTxt.textContent = 'Erreur'; dot.style.background = '#ef4444'; });

    client.on('message', (topic, message) => {
      const s = message.toString();
      // accept plain number or JSON {"value":...}
      let v = s;
      try{ const j = JSON.parse(s); if(j && typeof j === 'object' && 'value' in j) v = j.value; }catch(e){}
      const num = parseFloat(v);
      if(topic === TOPIC_TEMP && !isNaN(num)){
        tempEl.textContent = num.toFixed(1);
        tUp.textContent = 'Dernière mise à jour: ' + now();
      }
      if(topic === TOPIC_HUM && !isNaN(num)){
        humEl.textContent = Math.round(num);
        hUp.textContent = 'Dernière mise à jour: ' + now();
      }
    });
  </script>
</body>
</html>
